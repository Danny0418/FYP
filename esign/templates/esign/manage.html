<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Add this in the head section of your HTML file -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <!-- Add this in the head section of your HTML file -->
<!-- Use the latest version of idle-js from jsDelivr -->
<!-- <script src="https://cdn.jsdelivr.net/npm/idle-js@1.2.0/dist/Idle.min.js"></script> -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
<!-- PDF.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer" />


<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">

<!-- DataTables JavaScript -->
<script type="text/javascript" src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>

<script type="text/javascript" src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
{% load static %}
<!-- <link rel="stylesheet" href="https://cdn.datatables.net/v/dt/jqc-1.12.4/dt-1.13.6/b-2.4.2/sl-1.7.0/datatables.min.css"/>
<link rel="stylesheet" href="{% static 'css/editor.dataTables.css' %}">
 
<script src="https://cdn.datatables.net/v/dt/jqc-1.12.4/dt-1.13.6/b-2.4.2/sl-1.7.0/datatables.min.js"></script>
<script src="{% static 'css/dataTables.editor.js' %}"></script> -->

<!-- CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />

    <meta charset="UTF-8">
    <title>{{document.title}}</title>
    <script>
      function checkSessionStatus() {
          // Send an AJAX request to a Django view that checks the session status
          var xhr = new XMLHttpRequest();
          xhr.open('GET', '/esign/check_session/', true);
          xhr.onreadystatechange = function () {
              if (xhr.readyState === 4) {
                  if (xhr.status === 200) {
                      var response = JSON.parse(xhr.responseText);
                      if (response.session_expired) {
    
                        // Create a new Bootstrap modal element
                var modalHTML = `
                  <div class="modal fade" id="sessionExpiredModal" tabindex="-1" role="dialog" aria-labelledby="sessionExpiredModalLabel" aria-hidden="true" data-backdrop="static">
                    <div class="modal-dialog" role="document">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="sessionExpiredModalLabel">Session Expired</h5>
                        </div>
                        <div class="modal-body">
                          Your session has expired. Please log in again.
                        </div>
                        <div class="modal-footer">
                          <!-- Add any buttons or additional content here if needed -->
                          <a href="/esign/login" class="btn btn-primary">Log In</a>
                        </div>
                      </div>
                    </div>
                  </div>
                `;
    
                // Set the body content to the modal HTML
                document.body.innerHTML = modalHTML;
    
                // Show the Bootstrap modal
                $('#sessionExpiredModal').modal('show');
                          // Display an alert to the user
    //             alert("Your session has expired. Please log in again.");
    
    // // Redirect the user to the login page
    // window.location.href = '/esign/login';
                      }
                  } else {
                      console.error('Error checking session status:', xhr.statusText);
                  }
              }
          };
          xhr.send();
      }
    
      checkSessionStatus();
      // Check the session status every 60 seconds (adjust as needed)
      setInterval(checkSessionStatus, 60000);
    </script>


<style>
    /* Add custom styles for the canvas */
    #pdfCanvas {
        border: 5px solid #333; /* Thick border */
        width: 100%; /* Canvas width */
        height: 100%; /* Canvas height */
    }

    #logoutButton {
            position: absolute;
            bottom: 10px;
            left: 30px;
            border-radius: 4px;
            background-color: #f4511e;
            border: none;
            color: #FFFFFF;
            text-align: center;
            font-size: 20px;
            padding: 20px;
            width: 120px;
            transition: all 0.5s;
            cursor: pointer;
            margin: 5px;
        }

        #logoutButton span {
            cursor: pointer;
            display: inline-block;
            position: relative;
            transition: 0.5s;
        }

        #logoutButton span:after {
            content: '\00bb';
            position: absolute;
            opacity: 0;
            top: 0;
            right: -20px;
            transition: 0.5s;
        }

        #logoutButton:hover span {
            padding-right: 25px;
        }

        #logoutButton:hover span:after {
            opacity: 1;
            right: 0;
        }
</style>
</head>
<body>
    <div class="container-fluid ">
        <div style="height: 5vh;" class="d-flex align-items-center">
            <a href="{% url 'esign:index' %}" class="ms-5" style="text-decoration: none; color: black;">
                <i class="fa-solid fa-backward"></i>&nbsp; Back
            </a>
        </div>
        <div class="d-flex flex-column max-vh-70 justify-content-center mx-5">
            <div class="row">
                <div class="col-4" id="pdfContainer" data-document-id="{{ docID }}">
                    <canvas id="pdfCanvas"></canvas> <!-- Element to display PDF -->
                </div>
                <div class="col-8">
                    <div class="row mb-3">
                        <div class="d-flex bd-highlight">
                            <div class="flex-grow-1 bd-highlight" style="width: 40vw;">
                                <h2>
                                    <span id="editableTitle" style="cursor: pointer;">
                                        <b>{{ document.title }}</b>
                                        <span style="font-size: 20px;">&nbsp; &nbsp;<i class="fa-regular fa-pen-to-square edit-icon"></i></span>
                                    </span>
                                </h2>
                                <input type="text" id="editTitleInput" style="display: none;">
                            </div>
                            
                            <div class=" bd-highlight"><!-- Add a button to view history-->
                                <button type="button" class="btn" data-bs-toggle="modal" data-bs-target="#historyModal">
                                    View History &nbsp;<span style="font-size: 20px"><i class="far fa-clock"></i></span>
                                </button></div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="d-grid">
                            <!-- Add a button to redirect to detail.html to sign the document -->
                            <a href="{% url 'esign:sign' hashed_url %}" class="btn btn-success">View</a>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            
                            <div class="d-flex bd-highlight">
                                <div class=" flex-grow-1 bd-highlight"><h3><b>Signer List</b></h3></div>
                                <div class=" bd-highlight"><!-- Add a button to assign signer-->
                                    <button id="sendButton" class="btn btn-primary px-4" data-bs-toggle="modal" data-bs-target="#sendModal">
                                        Send Mail
                                    </button>
                                    <button id="editButton" class="btn btn-warning px-5" data-bs-toggle="modal" data-bs-target="#editModal">
                                        Edit
                                    </button>
                                </div>
                                    
                            </div>
                            <select class="form-select" id="signerListSelect" multiple aria-label="multiple select example" style="height: 32vh; border: 5px solid #333; font-size:20px; overflow: scroll;">
                                {% for user_id, comps, username, emails, role_for_user in user_data %}
                                <option value="{{ user_id }}">
                                    {{ comps }} ({{ username }}) ({{ emails }}) (
                                        {% for role in role_for_user %}
                                            {{ role.type }}
                                        {% endfor %}
                                    )
                                </option>
                            {% endfor %}
                            </select>
                        </div>
                        <div class="col-6">
                            <div class="d-flex bd-highlight">
                                <div class=" flex-grow-1 bd-highlight"><h3><b>Assign Signer</b></h3></div>
                                <div class=" bd-highlight"><!-- Add a button to assign signer-->
                                    <button type="button" id="assignButton" class="btn btn-primary px-5">
                                        <b>Assign</b>
                                    </button></div>
                                    
                            </div>
                            
                            <div class="container" style="height: 32vh; border: 5px solid #333; overflow-y: scroll;">
                                <div class="row mt-4">
                                    <div class="form-group">
                                        <label for="compSelect"><b>Company</b></label>
                                        <select class="form-select" id="compSelect"  aria-label="select example" style="border:1px solid #aaa; color: grey;">
                                            {% for company in companies %}
                                                <option value="{{ company.pk }}">{{ company.name }}</option>
                                            {% endfor %}
                                    </select>
                                        <!-- <input type="text" id="company" class="form-control" placeholder="Coffee Sdn Bhd" name="company" required> -->
                                    </div>
                                </div>
                                <div class="row mt-4">
                                    <div class="form-group">
                                        <label for="nameSelect"><b>Name (E-mail)</b></label>
                                        <select class="form-select" id="nameSelect"  aria-label="select example" style="border:1px solid #aaa; color: grey;">
                                
                                    </select>
                                        <!-- <input type="text" id="name" class="form-control" placeholder="John Doe" name="name" required> -->
                                    </div>
                                </div>
                                <!-- <div class="row mt-2">
                                    <div class="form-group">
                                        <label for="email"><b>E-mail<span style="color: red;"> *</span></b></label>
                                        <select class="form-control" id="mailSelect" multiple aria-label="multiple select example">
                                
                                            <option value="1"><b>One</b></option>
                                            <option value="2">Two</option>
                                            <option value="3">Three</option>
                                    </select> -->
                                        <!-- <input type="text" id="email" class="form-control" placeholder="johndoe@doe.com" name="email" required> -->
                                    <!-- </div>
                                </div> -->
                                <div class="row mt-4">
                                    <div class="form-group">
                                        <label for="roleSelect"><b>Role</b></label>
                                        <select class="form-select" id="roleSelect"  aria-label=" select example" style="border:1px solid #aaa; color: grey;">
                                            <option value="" selected disabled>Search for a role</option>
                                            <option value="Owner">Owner</option>
                                            <option value="BOD">Board of Directors</option>
                                            <option value="CS">Company Secretary</option>
                                        </select>
                                        <!-- <input type="text" id="role" class="form-control" placeholder="Role" name="role" required> -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="container">
                            <h3><b>Remark</b></h3>
                            <div class="container pt-2" style="height: 30vh; border: 5px solid #333;">
                                <div class="container" style="height: 12vh; overflow-y: scroll;">
                                    {% load static %}
                                    {% if remark_data %}
                                    {% for remark_info in remark_data %}
                                        <div class="d-flex pt-3" style="height: fit-content;">
                                            <div style="width: fit-content;">
                                                <img src="{% static "images/香格里拉 雪山 打光.jpg" %}" alt="" style="width: 60px; height: 60px; object-fit: cover;">
                                            </div>
                                            <div style="width: 95%; margin-left: 30px;">
                                                
                                                    <h6><b>{{ remark_info.username  }}</b><span style="color:grey; margin-left: 50px;">{{ remark_info.created_date }}</span></h6>
                                                    <p>{{ remark_info.content  }}</p>
                                                
                                            </div>
                                            
                                        </div>
                                        {% endfor %}
                                        {% else %}
                                        <p>No remarks available.</p>
                                    {% endif %}
                                </div>
                                <div class="form-group pt-3">
                                    <textarea class="form-control" id="remark" rows="2" placeholder="Leave a message..." name="remark" required style="resize: none;"></textarea>
                                </div>
                                <div class="d-grid">
                                    <button type="button" class="btn btn-primary mt-3" id="submitRemarkBtn">
                                        <b>Submit</b>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div style="height: 5vh;" class="mt-3">
            <div class="row">
                <div class="col-4">
                </div>
                <div class="col-8">
                    <div class="d-flex justify-content-center">
                        <label for="expDate"><b>Expiry Date:&nbsp;</b></label>
                        {% if docDue == "1900-01-01T00:00" %}
                            <input type="datetime-local" id="expDate" name="expDate" value=""  min="{{ docCreate }}">
                        {% else %}
                            <input type="datetime-local" id="expDate" name="expDate" value="{{ docDue }}"  min="{{ docCreate }}">
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    

    <!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" role="dialog" aria-labelledby="confirmationModalLabel" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmationModalLabel">Confirmation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Confirmation message or additional information -->
                Are you sure you want to proceed?
            </div>
            <div class="modal-footer">
                <!-- Buttons to confirm or cancel -->
                <button type="button" class="btn btn-secondary" id="cancelAction" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmAction">Confirm</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="dateModal" tabindex="-1" role="dialog" aria-labelledby="dateModalLabel" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dateModalLabel">Confirmation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" id="dateCloseAction" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Confirmation message or additional information -->
                Are you sure you want to proceed?
            </div>
            <div class="modal-footer">
                <!-- Buttons to confirm or cancel -->
                <button type="button" class="btn btn-secondary" id="dateCancelAction" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="dateConfirmAction">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Send modal -->
<div class="modal fade" id="sendModal" tabindex="-1" role="dialog" aria-labelledby="sendModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sendModalLabel">Send Mail</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Confirmation message or additional information -->
                Are you sure you want to send mail to all the signers?<br>
                <b style="color: red;">(Please ensure that you have assigned the correct signers, no changes can be made after sending the mail.)</b>
            </div>
            <div class="modal-footer">
                <!-- Buttons to confirm or cancel -->
                <button type="button" class="btn btn-secondary" id="sendCancelAction" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="sendConfirmAction">Confirm</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('sendConfirmAction').addEventListener('click', function() {
        var docID = 'DOC001';  // Replace with the actual document ID
    
        $.ajax({
            url: '/esign/signer_email/',
            method: 'POST',
            data: {
                docID: '{{ docID }}',
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                alert('Emails sent successfully!');
                location.reload();
            },
            error: function(xhr, status, error) {
                alert('An error occurred while sending emails.');
            }
        });
    });
    </script>


<!-- Logout button -->
<button id="logoutButton" data-bs-toggle="modal" data-bs-target="#logoutModal">
    <span>Logout</span>
</button>

<!-- Logout Confirmation Modal -->
<div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logoutModalLabel">Logout Confirmation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to log out?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <a href="{% url 'esign:logout' %}" class="btn btn-danger">Logout</a>
            </div>
        </div>
    </div>
</div>








<!-- SignerList Modal -->
<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Edit Roles</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Editable Data Table -->
                <div class="table-responsive">

                    <table id="editableTable" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Company</th>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Roles</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user_id, comps, username, emails, role_for_user in user_data %}
                            {% for role in role_for_user %}
                                {% if role.type != "Owner" %}
                            <tr>
                                <td>{{ user_id }}</td>
                                <td>{{ comps }}</td>
                                <td>{{ username }}</td>
                                <td>{{ emails }}</td>
                                <td>
                                    <select class="form-select role-select" aria-label="Select role">
                                        <option value="Owner" {% if role.type == "Owner" %} selected {% endif %}>Owner</option>
                                        <option value="BOD" {% if role.type == "BOD" %} selected {% endif %}>BOD</option>
                                        <option value="CS" {% if role.type == "CS" %} selected {% endif %}>CS</option>
                                    </select>
                                </td>
                                <td>
                                    <button class="btn btn-primary edit-btn">Edit</button>
                                    <button class="btn btn-danger delete-btn">Delete</button>
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                            {% endfor %}
                        </tbody>
                        </table>
                </div>

                    
                <div class="table-responsive mt-5">
                    <table id="ownerTable" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Company</th>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Roles</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user_id, comps, username, emails, role_for_user in user_data %}
                            {% for role in role_for_user %}
                            {% if role.type == "Owner" %}
                            <tr>
                                <td>{{ user_id }}</td>
                                <td>{{ comps }}</td>
                                <td>{{ username }}</td>
                                <td>{{ emails }}</td>
                                <td>
                                    <select class="form-select role-select" aria-label="Select role">
                                        <option value="Owner" {% if role.type == "Owner" %} selected {% endif %}>Owner</option>
                                        <option value="BOD" {% if role.type == "BOD" %} selected {% endif %}>BOD</option>
                                        <option value="CS" {% if role.type == "CS" %} selected {% endif %}>CS</option>
                                    </select>
                                </td>
                                <td>
                                    <button class="btn btn-primary edit-btn">Edit</button>
                                    <button class="btn btn-danger delete-btn">Delete</button>
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                            {% endfor %}
                        </tbody>
    
                        
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        function updateDocUtil() {
            var check = $('#ownerTable tbody tr').length;
            
            $('#ownerTable .role-select, #ownerTable .delete-btn').prop('disabled', ownerCount <= 1);

            if (ownerCount <= 1) {
                // Optionally, you can also visually indicate that these buttons are disabled
                $('#ownerTable .edit-btn, #ownerTable .delete-btn').addClass('disabled');
            } else {
                $('#ownerTable .edit-btn, #ownerTable .delete-btn').removeClass('disabled');
            }
        }

        // Initialize DataTables for enhanced features
        let table = new DataTable('#editableTable', {
            columnDefs: [
                { targets: [0, 5], orderable: false }
            ]
        });

        // Initialize DataTables for enhanced features
        let ownerTable = new DataTable('#ownerTable', {
            columnDefs: [
                { targets: [0, 5], orderable: false }
            ]
        });

        updateOwnerActions();

        // Event listener for role select focus
        $('.role-select').on('focus', function () {
            // Store the current value as the original value
            $(this).data("originalRole", $(this).val());
        }).change(function () {
            var selectedRole = $(this).val();
            var row = $(this).closest('tr');

            $('#confirmRoleChangeModal').data('selectedRole', selectedRole);
            $('#confirmRoleChangeModal').data('row', row);
            $('#editModal').modal('hide');
            $('#confirmRoleChangeModal').modal('show');
        });

        // Handle confirm role change
        $('#confirmRoleChange').on('click', function () {
            var selectedRole = $('#confirmRoleChangeModal').data('selectedRole');
            var row = $('#confirmRoleChangeModal').data('row');

            // Now, send the updated data to the server
            var updatedData = {
                id: row.find('td:first').text(),
                role: selectedRole,
                // Add other necessary data
            };

            

            updateRoleOnServer(updatedData);
            var originalRole = row.find('.role-select').data('originalRole');
                moveRowToCorrectTable(row, selectedRole, originalRole);

            $('#confirmRoleChangeModal').modal('hide');
            $('#editModal').modal('show');
        });

        // Handle cancel role change using originalRole
        $('.cancelRoleChange').on('click', function () {
            var row = $('#confirmRoleChangeModal').data('row');
            var originalRole = row.find('.role-select').data('originalRole');

            // Set the role back to the original value
            row.find('.role-select').val(originalRole);
            $('#confirmRoleChangeModal').modal('hide');
            $('#editModal').modal('show');
        });

        // Delete Handler
        $('#editableTable').on('click', '.delete-btn', function () {
            var row = $(this).closest('tr');
            var idToDelete = row.find('td:first').text();

            if (confirm('Are you sure you want to delete this signer?')) {
                // Send delete request to the server
                deleteDataOnServer(idToDelete);

                // Remove the row from the table
                row.remove();
                $('#signerListSelect option[value="' + idToDelete + '"]').remove();
            }
        });
        

        // Delete Handler
        $('#ownerTable').on('click', '.delete-btn', function () {
            var row = $(this).closest('tr');
            var idToDelete = row.find('td:first').text();

            if (confirm('Are you sure you want to delete this owner?')) {
                // Send delete request to the server
                deleteDataOnServer(idToDelete);

                // Remove the row from the table
                row.remove();
                $('#signerListSelect option[value="' + idToDelete + '"]').remove();
            }
        });
    });

    function updateRoleOnServer(data) {
        $.ajax({
            url: '/esign/update_role/', // Update with your URL
            method: 'POST',
            data: {
                id: data.id,
                role: data.role,
                doc: '{{ docID }}',
                csrfmiddlewaretoken: '{{ csrf_token }}',
            },
            success: function (response) {
                // Handle success
                updateOwnerActions();
                console.log('Role update successful', response);
            },
            error: function (error) {
                // Handle error
                console.error('Role update failed', error);
            }
        });
    }

    function moveRowToCorrectTable(row, newRole, originalRole) {
        // Check if the role change is between Owner and non-Owner
        if (newRole === "Owner" && originalRole !== "Owner") {
            // Move row to ownerTable if the new role is Owner and the original role was not Owner
            $('#ownerTable tbody').append(row);
        } else if (newRole !== "Owner" && originalRole === "Owner") {
            // Move row to editableTable if the new role is not Owner and the original role was Owner
            $('#editableTable tbody').append(row);
        }
        // If the role change is between non-Owner roles, do nothing (the row remains in the same table)
    }

    // Function to send updated data to the server
    function deleteDataOnServer(data) {
        $.ajax({
            url: '/esign/delete_permission/',
            method: 'POST',
            data: {
                id: data,
                doc: '{{ docID }}',
                csrfmiddlewaretoken: '{{ csrf_token }}', // Include CSRF token
            },
            success: function (response) {
                // Handle success
                updateOwnerActions();
                console.log('Delete successful', response);
            },
            error: function (error) {
                // Handle error
                console.error('Delete failed', error);
            }
        });
    }

    function updateOwnerActions() {
    var ownerCount = $('#ownerTable tbody tr').length;
    
    $('#ownerTable .role-select, #ownerTable .delete-btn').prop('disabled', ownerCount <= 1);

    if (ownerCount <= 1) {
        // Optionally, you can also visually indicate that these buttons are disabled
        $('#ownerTable .edit-btn, #ownerTable .delete-btn').addClass('disabled');
    } else {
        $('#ownerTable .edit-btn, #ownerTable .delete-btn').removeClass('disabled');
    }
}
</script>

<div class="modal fade" id="confirmRoleChangeModal" tabindex="-1" role="dialog" aria-labelledby="confirmRoleChangeModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmRoleChangeModalLabel">Confirm Role Change</h5>
                <button type="button" class="btn-close cancelRoleChange" data-bs-target="#editModal" data-bs-toggle="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to change the role?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary cancelRoleChange" data-bs-target="#editModal" data-bs-toggle="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmRoleChange" data-bs-target="#editModal" data-bs-toggle="modal">Confirm</button>
            </div>
        </div>
    </div>
</div>



<!-- Edit Modal -->
<div class="modal fade" id="updateModal" tabindex="-1" role="dialog" aria-labelledby="updateModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateModalLabel">Edit Data</h5>
            </div>
            <div class="modal-body">
                <!-- Form for editing -->
                <form id="editForm">
                    <div class="form-group">
                        <label for="editName">Name</label>
                        <input type="text" class="form-control" id="editName">
                    </div>
                    <div class="form-group">
                        <label for="editEmail">Email</label>
                        <input type="email" class="form-control" id="editEmail">
                    </div>
                    <!-- Add more fields as needed -->
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-target="#editModal" data-bs-toggle="modal">Back</button>
                <button type="button" class="btn btn-primary" id="saveChanges" data-bs-target="#editModal" data-bs-toggle="modal">Save changes</button>
            </div>
        </div>
    </div>
</div>




<script>
    $(document).ready(function() {
        // When an Edit button is clicked
        $('#editableTable').on('click', '.edit-btn', function() {
            var row = $(this).closest('tr');
            var name = row.find('td:eq(1)').text(); // Adjust the index as per your table
            var email = row.find('td:eq(2)').text(); // Adjust the index as per your table
    
            // Set the values in the modal inputs
            $('#editName').val(name);
            $('#editEmail').val(email);
    
            // Show the modal
            $('#editModal').modal('hide');
            $('#updateModal').modal('show');
        });
    
        // Handle the save changes button
        $('#saveChanges').on('click', function() {
            var editedName = $('#editName').val();
            var editedEmail = $('#editEmail').val();
    
            // Add logic to save the edited data, possibly via AJAX to server
    
        });
    });
    </script>
    



</body>


<!-- Include Bootstrap JS and jQuery -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js" integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+" crossorigin="anonymous"></script>


<!-- JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

<script>
    // Load and render the first page of the PDF document
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    const pdfUrl = '{{ document.pdf_file.url }}'; // Replace with the actual URL or path of your PDF document
    const canvas = document.getElementById('pdfCanvas');
    const context = canvas.getContext('2d');
    const parentDiv = canvas.parentElement;

    pdfjsLib.getDocument(pdfUrl).promise.then(function (pdf) {
        pdf.getPage(1).then(function (page) {
            const viewport = page.getViewport({ scale: 1 });
            canvas.height = viewport.height;
            canvas.width = parentDiv.clientWidth;
            const scale = canvas.width / viewport.width;

            const renderContext = {
                canvasContext: context,
                viewport: page.getViewport({ scale: scale }),
            };
            page.render(renderContext);
        });
    }).catch(function (error) {
        console.error('Error loading PDF:', error);
    });
</script>

<script>
    $(document).ready(function () {
        var dateCheck = '{{ docDue }}';
        var selectedDate;
        if (dateCheck == "1900-01-01T00:00") {
            $('#expDate').val('');;
        }

        // Listen for changes in the datetime-local input field
        $('#expDate').on('change', function () {
            // Get the selected datetime value
            selectedDate = $(this).val();


            // Check if the selected date is not empty
            if (selectedDate) {
                // Show the Bootstrap confirmation modal
                $('#dateModal').modal('show');
            }
        });

        function formatDateTime(datetimeString) {
            const date = new Date(datetimeString);

            // Extract date components
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();

            // Get hours and minutes
            let hours = date.getHours();
            const minutes = date.getMinutes().toString().padStart(2, '0');

            // Convert hours to 12-hour format and determine AM or PM
            const meridiem = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12 || 12; // Convert hours from 24-hour to 12-hour format

            // Format the datetime string
            const formattedDateTime = `${day}/${month}/${year} ${hours}:${minutes} ${meridiem}`;

            return formattedDateTime;
        }

        // Handle confirmation or cancellation within the modal if needed
        $('#dateConfirmAction').on('click', function () {
            // Get the selected datetime value
            var minExpDate = $('#expDate').attr('min'); // Get the minimum expiry time
            var formattedMinDate = formatDateTime(minExpDate);



            if (selectedDate < minExpDate) {
                // Display an error message or take appropriate action
                alert('Expiry date could not be set before: ' + formattedMinDate);
                return; // Prevent further execution of the assignment logic
            }

            $.ajax({
                url: '/esign/update_due/', // Replace with your server-side endpoint URL
                method: 'POST',
                data: {
                    new_due: selectedDate,
                    document_id: '{{ docID }}',
                    csrfmiddlewaretoken: '{{ csrf_token }}', // Include CSRF token
                },
                dataType: 'json',
                success: function (response) {
                    if (response.success) {
                        dateCheck = $('#expDate').val();

                        // Hide the modal once the action is completed
                        $('#dateModal').modal('hide');

                        var formattedDateTime = formatDateTime(selectedDate);

                        // Display a success message to the user
                        var successMessage = 'Expiry date successfully updated to ' + formattedDateTime + '!';

                        // Show Bootstrap success modal
                        var successModal = $('<div class="modal fade" id="successModal" tabindex="-1" role="dialog" aria-labelledby="successModalLabel" aria-hidden="true" data-backdrop="static">' +
                            '<div class="modal-dialog" role="document">' +
                            '<div class="modal-content bg-success">' + // Set the background color to light green
                            '<div class="modal-header">' +
                            '<h5 class="modal-title text-white" id="successModalLabel">Success</h5>' +
                            '</div>' +
                            '<div class="modal-body text-white">' + // Set the text color to white
                            successMessage +
                            '</div>' +
                            '</div>' +
                            '</div>' +
                            '</div>');

                        $('body').append(successModal);
                        $('#successModal').modal('show');

                        // Close the success modal after 5 seconds
                        setTimeout(function () {
                            $('#successModal').modal('hide');
                            successModal.remove();
                        }, 5000);
                    } else {
                        // Handle failure if needed
                        alert('Error updating expiry date!');
                    }
                },
                error: function (xhr, errmsg, err) {
                    // Handle error if needed
                    alert('Error updating expiry date!');
                }
            });


        });

        // Handle cancellation within the modal if needed
        $('#dateCancelAction, #dateCloseAction').on('click', function () {
            // set expiry date back to original
            if (dateCheck == "1900-01-01T00:00") {
                $('#expDate').val('');;
            } else {
                $('#expDate').val(dateCheck);
            }

            // Hide the modal upon cancellation
            $('#dateModal').modal('hide');
        });




        $('#compSelect').select2({
            placeholder: 'Search for a company',
            allowClear: false // Optional - adds a clear button
        });

        // Event listener for company selection change
        $('#compSelect').on('change', function () {
            var selectedCompany = $(this).val();
            // console.log(typeof (selectedCompany));

            // Make an AJAX request to fetch associated names and emails for the selected company
            $.ajax({
                url: '/esign/get_names_emails/', // Replace with your server-side endpoint URL
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}' // Include the CSRF token here
                },
                data: {
                    company_id: selectedCompany
                },
                traditional: true,
                success: function (response) {
                    // Assuming the response contains options for names and emails
                    var names = response.names;

                    // Clear existing options
                    $('#nameSelect').empty();
                    //   $('#mailSelect').empty();

                    // Populate name options
                    names.forEach(function (name) {
                        if (signerNames.includes(name.value)) {

                        } else {
                            $('#nameSelect').append($('<option>', {
                                value: name.value,
                                text: name.text
                            }));
                        }

                    });

                    // Trigger change event to update Select2 dropdown UI
                    $('#nameSelect').trigger('change');
                },
                error: function (xhr, status, error) {
                    console.error('Error fetching data:', error);
                }
            });
        });

        $('#nameSelect').select2({
            placeholder: 'Search for a name',
            allowClear: false // Optional - adds a clear button
        });

        var signerNames = []; // Array to store signer names

        // Function to update the signer list select element
        function updateSignerList(selectedID) {

            signerNames.push(selectedID); // Add selected name to the array
        }


        function getSignerList() {
            // loop through the existed signer list option and store the names in an array
            $('#signerListSelect option').each(function () {
                signerNames.push($(this).val());
            });
            console.log(signerNames);
        }
        getSignerList();

        // Retrieve selected values for organization, name, and role
        var selectedOrganization, selectedID, selectedName, selectedRole;

        // Assuming the assign button has an ID of 'assignButton'
        $('#assignButton').on('click', function () {
            // Retrieve selected values for organization, name, and role
            selectedOrganization = $('#compSelect').find('option:selected').text();
            selectedID = $('#nameSelect').val();
            selectedName = $('#nameSelect').find('option:selected').text();
            selectedRole = $('#roleSelect').find('option:selected').text();

            console.log(signerNames);
            console.log(selectedID);

            var selectedExpDate = $('#expDate').val(); // Get the value of the selected expiry time
            var minExpDate = $('#expDate').attr('min'); // Get the minimum expiry time
            var formattedMinDate = formatDateTime(minExpDate);


            if (selectedExpDate == "") {
                // Display an error message or take appropriate action
                alert('Please insert the expiry date before assigning signers.');
                return; // Prevent further execution of the assignment logic
            }

            if (selectedExpDate < minExpDate) {
                // Display an error message or take appropriate action
                alert('Expiry date could not be set before: ' + formattedMinDate);
                return; // Prevent further execution of the assignment logic
            }

            if (selectedRole == "Search for a role") {
                // Display an error message or take appropriate action
                alert('Please select a role before assigning signers.');
                return; // Prevent further execution of the assignment logic
            }

            // Check if all necessary fields are selected
            if (selectedOrganization && selectedID && selectedRole) {

                $('#confirmationModal').modal('show');
            } else {
                // Display an error message if all necessary fields are not selected
                alert('Please select organization, name, and role.');
            }
        });

        // Listen for confirmation within the modal
        $('#confirmAction').on('click', function () {
            getSignerList();
            // Create a string to represent the signer
            var signerInfo = selectedOrganization + ' (' + selectedName + ') ' + '(' + selectedRole + ')';
            var check = 0;
            if (signerNames.includes(selectedID)) {
                check = 1;
            }

            var role = $('#roleSelect').val();
            console.log(selectedID);

            if (check === 1) {
                alert('Signer already exists in the list!');
                $('#confirmationModal').modal('hide');
            } else {
                $.ajax({
                    url: '/esign/update_permission/',
                    method: 'POST',
                    data: {
                        selectedID: selectedID,
                        selectedRole: role,
                        document_id: '{{ docID }}',
                        csrfmiddlewaretoken: '{{ csrf_token }}', // Include CSRF token
                    },
                    dataType: 'json',
                    success: function (response) {
                        if (response.success) {

                            // Hide the modal once the action is completed
                            $('#confirmationModal').modal('hide');

                            // Display a success message to the user
                            var successMessage = 'Signer list updated successfully! '

                            // Show Bootstrap success modal
                            var successModal = $('<div class="modal fade" id="successModal" tabindex="-1" role="dialog" aria-labelledby="successModalLabel" aria-hidden="true">' +
                                '<div class="modal-dialog" role="document">' +
                                '<div class="modal-content bg-success">' + // Set the background color to light green
                                '<div class="modal-header">' +
                                '<h5 class="modal-title text-white" id="successModalLabel">Success</h5>' +
                                '<button type="button" class="close" aria-label="Close" style="display:none;">' + // Hide the close button
                                '<span aria-hidden="true">&times;</span>' +
                                '</button>' +
                                '</div>' +
                                '<div class="modal-body text-white">' + // Set the text color to white
                                successMessage +
                                '</div>' +
                                '</div>' +
                                '</div>' +
                                '</div>');

                            // Prevent modal from closing when clicking outside or pressing Esc
                            // successModal.modal({
                            //     backdrop: 'static',
                            //     keyboard: false
                            // });

                            // Define the new row HTML based on the signer information
                            var nameEmailSplit = selectedName.split(' (');
                            var name = nameEmailSplit[0]; // Name part
                            var email = nameEmailSplit[1].slice(0, -1); // Email part, removing the closing parenthesis

                            // Define the new row HTML with separate name and email
                            var newRow = '<tr>' +
                                '<td>' + selectedID + '</td>' +
                                '<td>' + selectedOrganization + '</td>' +
                                '<td>' + name.trim() + '</td>' +
                                '<td>' + email.trim() + '</td>' +
                                '<td>' + '<select class="form-select role-select" aria-label="Select role">';

                            if (selectedRole === 'Owner') {
                                newRow += '<option value="Owner" selected>Owner</option>' +
                                    '<option value="BOD">BOD</option>' +
                                    '<option value="CS">CS</option>';
                            } else if (selectedRole === 'BOD') {
                                newRow += '<option value="Owner">Owner</option>' +
                                    '<option value="BOD" selected>BOD</option>' +
                                    '<option value="CS">CS</option>';
                            } else {
                                newRow += '<option value="Owner">Owner</option>' +
                                    '<option value="BOD">BOD</option>' +
                                    '<option value="CS" selected>CS</option>';
                            }

                            newRow += '</td>' +
                                '<td>' +
                                '<button class="btn btn-primary edit-btn">Edit</button> ' +
                                '<button class="btn btn-danger delete-btn">Delete</button>' +
                                '</td>' +
                                '</tr>';

                            // Append the row to the correct table based on the role
                            if (selectedRole === 'Owner') {
                                $('#ownerTable tbody').append(newRow);
                            } else {
                                $('#editableTable tbody').append(newRow);
                            }
                            updateOwnerActions();

                            $('body').append(successModal);
                            $('#successModal').modal('show');

                            // Close the success modal after 5 seconds
                            setTimeout(function () {
                                $('#successModal').modal('hide');
                            }, 3000);

                            // Add the signer to the signer list select element
                            $('#signerListSelect').append($('<option>', {
                                value: selectedID,
                                text: signerInfo
                            }));
                            getSignerList();
                            sendEmailToOwner(selectedID);

                        } else {
                            // Handle failure if needed
                            alert('Error updating signer list!');
                            $('#confirmationModal').modal('hide');
                        }
                    },
                    error: function (xhr, errmsg, err) {
                        // Handle error if needed
                        alert('Error updating signer list!');
                        $('#confirmationModal').modal('hide');
                    }
                });
            }
            signerNames = [];
        });

        function sendEmailToOwner(userID) {
            $.ajax({
                url: '/esign/owner_email/',
                method: 'POST',
                data: {
                    userID: userID,
                    docID: '{{ docID }}',
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(emailResponse) {
                    console.log('Email sent successfully to user:', userID);
                },
                error: function(xhr, status, error) {
                    console.error('Failed to send email to user:', userID);
                }
            });
        }
    });
</script>

<script>
    $(document).ready(function () {
        $(".edit-icon").click(function () {
            $("#editableTitle").hide();
            $("#editTitleInput").val($("#editableTitle b").text()).show().focus();
        });

        var isEventProcessed = false; // Flag to track event processing

        $("#editTitleInput").on('blur keypress', function (event) {
            if (event.type === 'blur' || (event.type === 'keypress' && event.which === 13)) {
                if (!isEventProcessed) { // Check if the event has already been processed
                    isEventProcessed = true; // Set the flag to true to indicate event processing
                    var newTitle = $(this).val();
                    if (newTitle.trim() !== "") {
                        $("#editableTitle b").text(newTitle);

                        // AJAX call to update the document title in the database
                        var documentId = $('#pdfContainer').data('document-id'); // Replace with the actual document ID
                        
                        $.ajax({
                            type: 'POST',
                            url: `/esign/update_document_title/${documentId}/`,
                            data: {
                                new_title: newTitle,
                                csrfmiddlewaretoken: '{{ csrf_token }}', // Include CSRF token
                            },
                            dataType: 'json',
                            success: function (response) {
                                if (response.success) {
                                    // Display a success message to the user
                        var successMessage = 'Document title updated successfully! '

                        // Show Bootstrap success modal
                        var successModal = $('<div class="modal fade" id="successModal" tabindex="-1" role="dialog" aria-labelledby="successModalLabel" aria-hidden="true" data-backdrop="static">' +
                            '<div class="modal-dialog" role="document">' +
                            '<div class="modal-content bg-success">' + // Set the background color to light green
                            '<div class="modal-header">' +
                            '<h5 class="modal-title text-white" id="successModalLabel">Success</h5>' +
                            '</div>' +
                            '<div class="modal-body text-white">' + // Set the text color to white
                            successMessage +
                            '</div>' +
                            '</div>' +
                            '</div>' +
                            '</div>');

                        $('body').append(successModal);
                        $('#successModal').modal('show');

                        // Close the success modal after 5 seconds
                        setTimeout(function () {
                            $('#successModal').modal('hide');
                            successModal.remove();
                        }, 5000);
                                } else {
                                    // Handle failure if needed
                                    alert('Error updating document title!');
                                }
                            },
                            error: function (xhr, errmsg, err) {
                                // Handle error if needed
                                alert('Error updating document title!');
                            },
                            complete: function () {
                                isEventProcessed = false; // Reset the flag after completing the AJAX call
                            }
                        });
                    }
                    $(this).hide();
                    $("#editableTitle").show();
                }
            }
        });
    });
    </script>
    
    <script>
        // Function to get the CSRF token from the cookie
function getCSRFToken() {
    const cookieValue = document.cookie
        .split('; ')
        .find(row => row.startsWith('csrftoken='))
        .split('=')[1];
    return cookieValue;
}

// Use the CSRF token in AJAX requests
const csrftoken = getCSRFToken();

        $(document).ready(function () {
            $('#submitRemarkBtn').click(function () {
                // Get the remark content and document ID
                var remarkContent = $('#remark').val();
    
                // Prepare the data to be sent to the server
                var formData = {
                    remark: remarkContent,
                    doc_id: '{{docID}}'
                };
    
                // Send an AJAX request to add the remark
                $.ajax({
                    type: 'POST',
                    url: '/esign/add_remark/', // Replace with your backend endpoint URL
                    headers: {
      'X-CSRFToken': csrftoken  // Add the CSRF token to the request headers
    },
                    data: formData,
                    success: function (response) {
                        // Handle success response (e.g., show a success message)
                        alert('Remark added successfully');
                        // Reload the page to display the new remark
                        location.reload();
                    },
                    error: function (error) {
                        // Handle error response (e.g., show an error message)
                        alert('Error adding remark');
                    }
                });
            });
        });
    </script>

</html>